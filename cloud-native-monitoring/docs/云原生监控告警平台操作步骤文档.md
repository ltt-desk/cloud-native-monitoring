# 云原生监控告警平台操作步骤文档

## 一、环境准备步骤

### 1.1 检查基础环境

在开始部署前，请确保您的环境满足以下要求：



```
\# 检查Kubernetes版本（需1.21+）

kubectl version --short

\# 检查Helm版本（需3.0+）

helm version --short

\# 检查集群节点资源

kubectl get nodes -o=jsonpath='{range .items\[\*]}{.metadata.name}{"\tCPU: "}{.status.allocatable.cpu}{"\t内存: "}{.status.allocatable.memory}{"\n"}{end}'
```

### 1.2 安装必要工具

如果缺少相关工具，请按照以下步骤安装：

**安装 kubectl：**



```
\# Ubuntu/Debian

sudo apt-get update && sudo apt-get install -y kubectl

\# macOS

brew install kubectl

\# 验证安装

kubectl version --client
```

**安装 Helm：**



```
\# 下载Helm

curl -fsSL -o get\_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3

chmod 700 get\_helm.sh

./get\_helm.sh

\# 验证安装

helm version
```

### 1.3 准备 Kubernetes 集群

确保集群已正确配置并可访问：



```
\# 检查集群信息

kubectl cluster-info

\# 检查节点状态（确保所有节点都是Ready状态）

kubectl get nodes

\# 创建必要的命名空间（脚本会自动创建，这里仅作为手动操作参考）

kubectl create namespace monitoring

kubectl create namespace logging
```

## 二、项目获取与部署步骤

### 2.1 获取项目代码



```
\# 克隆GitHub仓库

git clone https://github.com/your-username/cloud-native-monitoring.git

cd cloud-native-monitoring

\# 查看项目结构

tree -L 2  # 如果没有tree命令，可使用ls -lR
```

### 2.2 配置自定义参数（可选）

根据实际需求修改配置参数：



```
\# 修改告警邮箱配置

vi configs/alertmanager/alertmanager.yml

\# 修改资源配置（生产环境）

vi helm/monitoring/values.yaml

vi helm/efk/values.yaml

\# 修改资源配置（开发环境）

vi helm/monitoring/values-dev.yaml

vi helm/efk/values-dev.yaml
```

### 2.3 执行部署脚本



```
\# 部署生产环境（默认）

./scripts/deploy.sh

\# 部署开发环境

./scripts/deploy.sh -e development

\# 部署过程中会显示进度信息，等待所有组件部署完成

\# 部署成功后会显示各组件的访问方式和初始密码
```

### 2.4 验证部署结果



```
\# 检查部署状态

./scripts/check-status.sh

\# 检查命名空间中的Pod状态

kubectl get pods -n monitoring

kubectl get pods -n logging

\# 检查服务状态

kubectl get svc -n monitoring

kubectl get svc -n logging
```

## 三、平台使用步骤

### 3.1 访问各组件

**Grafana 访问：**



```
\# 端口转发

kubectl port-forward -n monitoring svc/monitoring-grafana 3000:80
```

打开浏览器访问：[http://localhost](http://localhost:3000)[:300](http://localhost:3000)[0](http://localhost:3000)

默认用户名：admin

密码获取：部署完成时的输出信息或执行以下命令：



```
kubectl get secret -n monitoring monitoring-grafana-credentials -o jsonpath='{.data.admin-password}' | base64 --decode
```

**Kibana 访问：**



```
\# 端口转发

kubectl port-forward -n logging svc/efk-kibana 5601:5601
```

打开浏览器访问：[http://localhost](http://localhost:5601)[:5601](http://localhost:5601)

**Prometheus 访问：**



```
\# 端口转发

kubectl port-forward -n monitoring svc/monitoring-prometheus 9090:80
```

打开浏览器访问：[http://localhost](http://localhost:9090)[:9090](http://localhost:9090)

**Alertmanager 访问：**



```
\# 端口转发

kubectl port-forward -n monitoring svc/monitoring-alertmanager 9093:80
```

打开浏览器访问：[http://localhost:909](http://localhost:9093)[3](http://localhost:9093)

### 3.2 Grafana 使用指南

#### 3.2.1 登录与初始设置



1.  使用获取的用户名和密码登录 Grafana

2.  首次登录建议修改密码：点击左侧菜单 -> "Preferences" -> "Change Password"

#### 3.2.2 导入仪表盘



1.  进入 "Dashboards" -> "Import"

2.  点击 "Upload JSON file"

3.  选择项目中的仪表盘文件：

*   `configs/grafana/dashboards/k8s-cluster.json`（K8s 集群监控）

*   `configs/grafana/dashboards/spring-boot-app.json`（Spring Boot 应用监控）

1.  选择数据源为 "Prometheus"，点击 "Import"

#### 3.2.3 使用仪表盘



*   切换时间范围：使用右上角的时间选择器

*   刷新数据：点击刷新按钮或设置自动刷新间隔

*   查看详情：点击图表可查看更详细的数据和设置

### 3.3 Kibana 使用指南

#### 3.3.1 首次使用设置



1.  访问 Kibana 后，进入 "Management" -> "Stack Management"

2.  选择 "Kibana" -> "Index Patterns"

3.  点击 "Create index pattern"

4.  输入`logs-*`作为索引模式名称

5.  选择时间字段为`@timestamp`

6.  点击 "Create index pattern"

#### 3.3.2 日志查询



1.  进入 "Analytics" -> "Discover"

2.  使用时间选择器设置查询时间范围

3.  在搜索框中输入查询条件，例如：

*   按日志级别查询：`level: ERROR`

*   按应用名称查询：`kubernetes.labels.app: spring-boot-example`

*   组合查询：`level: ERROR AND kubernetes.labels.app: spring-boot-example`

1.  点击 "Refresh" 执行查询

### 3.4 告警配置与测试

#### 3.4.1 配置告警接收方式



1.  修改 Alertmanager 配置：



```
vi configs/alertmanager/alertmanager.yml
```



1.  更新配置：



```
helm upgrade monitoring ./helm/monitoring -n monitoring
```

#### 3.4.2 测试告警功能



```
\# 创建一个压力测试Pod，模拟高CPU和内存使用

kubectl run stress-test --image=progrium/stress -- stress --cpu 2 --memory 1024M --timeout 300s

\# 查看Prometheus告警是否触发

\# 访问Prometheus UI的Alerts页面：http://localhost:9090/alerts
```

## 四、维护与管理步骤

### 4.1 日常检查



```
\# 检查系统状态

./scripts/check-status.sh

\# 查看组件日志

kubectl logs -n monitoring \<prometheus-pod-name> -f

kubectl logs -n monitoring \<grafana-pod-name> -f

kubectl logs -n logging \<fluentd-pod-name> -f

\# 检查Elasticsearch健康状态

kubectl exec -n logging \<elasticsearch-pod-name> -- curl http://localhost:9200/\_cluster/health?pretty
```

### 4.2 配置更新



```
\# 更新配置后重新部署

helm upgrade monitoring ./helm/monitoring -n monitoring

helm upgrade efk ./helm/efk -n logging

\# 或删除Pod使配置生效

kubectl delete pods -n monitoring --all

kubectl delete pods -n logging --all
```

### 4.3 数据清理



```
\# 清理Prometheus数据（谨慎操作，会丢失历史数据）

kubectl delete pvc -n monitoring prometheus-storage

\# 清理Elasticsearch数据（谨慎操作，会丢失日志数据）

kubectl delete pvc -n logging elasticsearch-data
```

### 4.4 升级平台



```
\# 拉取最新代码

git pull origin main

\# 重新部署

./scripts/deploy.sh
```

### 4.5 卸载平台



```
\# 执行卸载脚本

./scripts/uninstall.sh

\# 脚本会提示是否删除命名空间和数据，根据需求选择
```

## 五、常见问题处理步骤

### 5.1 部署失败



1.  查看部署错误信息：



```
helm status monitoring -n monitoring

helm status efk -n logging
```



1.  检查 Pod 事件：



```
kubectl describe pod \<pod-name> -n monitoring

kubectl describe pod \<pod-name> -n logging
```



1.  常见问题及解决：

*   资源不足：增加节点资源或调整 values.yaml 中的资源限制

*   镜像拉取失败：检查网络连接或配置镜像仓库

*   权限问题：确保执行用户有足够的集群权限

### 5.2 告警不触发



1.  检查 Prometheus 规则是否加载：

    访问 Prometheus UI 的 Rules 页面：[http://localhost:9090/rules](http://localhost:9090/rules)

2.  检查 Alertmanager 配置：



```
kubectl exec -n monitoring \<alertmanager-pod-name> -- cat /etc/alertmanager/alertmanager.yml
```



1.  查看 Alertmanager 日志：



```
kubectl logs -n monitoring \<alertmanager-pod-name> -f
```

### 5.3 日志不显示



1.  检查 Fluentd 日志：



```
kubectl logs -n logging \<fluentd-pod-name> -f
```



1.  检查 Elasticsearch 是否有索引：



```
kubectl exec -n logging \<elasticsearch-pod-name> -- curl http://localhost:9200/\_cat/indices
```



1.  检查 Kibana 索引模式是否正确：

    进入 Kibana 的 "Index Patterns" 页面确认配置

## 六、示例应用部署步骤

为了测试监控平台的功能，可以部署一个示例 Spring Boot 应用：



```
\# 部署示例应用

kubectl apply -f examples/spring-boot-example.yaml

\# 查看应用状态

kubectl get pods -l app=spring-boot-example

\# 生成测试日志

kubectl exec -it \<spring-boot-pod-name> -- curl http://localhost:8080/test/logs
```

部署后，可以在 Grafana 中查看应用的监控指标，在 Kibana 中查看应用日志。

> （注：文档部分内容可能由 AI 生成）